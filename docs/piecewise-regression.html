<!DOCTYPE html>
<html lang="" xml:lang="" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>2 Piecewise Regression | Machine Learning for Biostatistics</title>
  <meta name="description" content="2 Piecewise Regression | Machine Learning for Biostatistics" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="2 Piecewise Regression | Machine Learning for Biostatistics" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="2 Piecewise Regression | Machine Learning for Biostatistics" />
  
  
  

<meta name="author" content="Jaroslaw Harezlak &amp; Armando Teixeira-Pinto" />


<meta name="date" content="2020-09-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="polynomial-regression.html"/>
<link rel="next" href="piecewise-regression.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:xd_Signature msdt:dt="string"></mso:xd_Signature>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor msdt:dt="string">Andrew Grant</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Editor>
<mso:Order msdt:dt="string">224900.000000000</mso:Order>
<mso:xd_ProgID msdt:dt="string"></mso:xd_ProgID>
<mso:_ExtendedDescription msdt:dt="string"></mso:_ExtendedDescription>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author msdt:dt="string">Andrew Grant</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_Author>
<mso:ComplianceAssetId msdt:dt="string"></mso:ComplianceAssetId>
<mso:TemplateUrl msdt:dt="string"></mso:TemplateUrl>
<mso:ContentTypeId msdt:dt="string">0x0101006078879AB8D2D9408BE90069FE7ACD8A</mso:ContentTypeId>
<mso:TriggerFlowInfo msdt:dt="string"></mso:TriggerFlowInfo>
<mso:_SourceUrl msdt:dt="string"></mso:_SourceUrl>
<mso:_SharedFileIndex msdt:dt="string"></mso:_SharedFileIndex>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><center><img src="bca.png"><H3><b><font color="F26531"> Machine Learning for Biostatistics </font> </b></H3> <a href="https://canvas.sydney.edu.au/courses/25406" style="color:364550" target="blank"><small><i> Back to canvas website </i></small></a></center></li>
<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Beyond Linearity</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#dataset-used-in-the-examples"><i class="fa fa-check"></i>Dataset used in the examples</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#slides-from-the-videos"><i class="fa fa-check"></i>Slides from the videos</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="polynomial-regression.html"><a href="polynomial-regression.html"><i class="fa fa-check"></i><b>1</b> Polynomial Regression</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="polynomial-regression.html"><a href="polynomial-regression.html#readings"><i class="fa fa-check"></i><b>1.2</b> Readings</a></li>
<li class="chapter" data-level="1.3" data-path="polynomial-regression.html"><a href="polynomial-regression.html#practice-session"><i class="fa fa-check"></i><b>1.3</b> Practice session</a><ul>
<li class="chapter" data-level="" data-path="polynomial-regression.html"><a href="polynomial-regression.html#task-1---fit-a-cubic-model"><i class="fa fa-check"></i>Task 1 - Fit a cubic model</a></li>
<li class="chapter" data-level="" data-path="polynomial-regression.html"><a href="polynomial-regression.html#task-2---mean-squared-error-for-the-quadratic-model"><i class="fa fa-check"></i>Task 2 - Mean Squared Error for the quadratic model</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="polynomial-regression.html"><a href="polynomial-regression.html#exercises"><i class="fa fa-check"></i><b>1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="piecewise-regression.html"><a href="piecewise-regression.html"><i class="fa fa-check"></i><b>2</b> Piecewise Regression</a><ul>
<li class="chapter" data-level="2.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="polynomial-regression.html"><a href="polynomial-regression.html#readings"><i class="fa fa-check"></i><b>2.2</b> Readings</a></li>
<li class="chapter" data-level="2.3" data-path="polynomial-regression.html"><a href="polynomial-regression.html#practice-session"><i class="fa fa-check"></i><b>2.3</b> Practice session</a><ul>
<li class="chapter" data-level="" data-path="piecewise-regression.html"><a href="piecewise-regression.html#task-1---fit-a-piecewise-linear-regression"><i class="fa fa-check"></i>Task 1 - Fit a piecewise linear regression</a></li>
<li class="chapter" data-level="" data-path="piecewise-regression.html"><a href="piecewise-regression.html#task-2---fit-a-natural-cubic-spline"><i class="fa fa-check"></i>Task 2 - Fit a natural cubic spline</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="polynomial-regression.html"><a href="polynomial-regression.html#exercises"><i class="fa fa-check"></i><b>2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="piecewise-regression.html"><a href="piecewise-regression.html#piecewise-regression"><i class="fa fa-check"></i><b>3</b> Piecewise Regression</a><ul>
<li class="chapter" data-level="3.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="polynomial-regression.html"><a href="polynomial-regression.html#readings"><i class="fa fa-check"></i><b>3.2</b> Readings</a></li>
<li class="chapter" data-level="3.3" data-path="polynomial-regression.html"><a href="polynomial-regression.html#practice-session"><i class="fa fa-check"></i><b>3.3</b> Practice session</a><ul>
<li class="chapter" data-level="" data-path="piecewise-regression.html"><a href="piecewise-regression.html#task-1---fit-a-piecewise-linear-regression"><i class="fa fa-check"></i>Task 1 - Fit a piecewise linear regression</a></li>
<li class="chapter" data-level="" data-path="piecewise-regression.html"><a href="piecewise-regression.html#task-2---fit-a-natural-cubic-spline"><i class="fa fa-check"></i>Task 2 - Fit a natural cubic spline</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="polynomial-regression.html"><a href="polynomial-regression.html#exercises"><i class="fa fa-check"></i><b>3.4</b> Exercises</a></li>
</ul></li>
<li class="divider"></li>
<li><center><a href="https://canvas.sydney.edu.au/courses/25406" style="color:364550" target="blank"><img src="usyd2.gif" width="60%"></a> <small>© A.Teixeira-Pinto, University of Sydney, 2020</small></center></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="../_book">Machine Learning for Biostatistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="piecewise-regression" class="section level1">
<h1><span class="header-section-number">2</span> Piecewise Regression</h1>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">2.1</span> Introduction</h2>
<p>An alternative to fit all data points with a single polynomial curve, is to
fit segments to different parts of the data, with breakpoints (knots) at
pre-determined places.</p>
<p><img src="piece1.png" /></p>
<p>We can further require continuity, meaning that the segments have to
be connected</p>
<p><img src="piece2.png" />
Again, the knots need to be specified and the regression equation becomes:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x +  \beta_2 (x-k_1)_{+}  + \beta_3 (x-k_2)_{+} + ... + \beta_6 (x-k_p)_{+} + \varepsilon\\
\]</span></p>
<p>where
<span class="math display">\[(x-k)_{+} =  \begin{cases}
                  0, &amp; \text{ if  } x &lt; k \\
                  x-k, &amp; \text{ if  } x \geq k\\
                 \end{cases} 
\]</span></p>
<p>The approach above may be extended to use polynomial segments. For example,
using cubic segments, the model would become</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x +  \beta_2 x^2 + \beta_3 x^3 + \beta_4 (x-k_1)_{+} + \beta_5 (x-k_1)^2_{+} + \beta_6 (x-k_1)^3_{+}   + ... +  \varepsilon
\]</span></p>
<p>The above model will be a smooth curve within the intervals bounded by the
knots, but the “connection” between the segments will not be smooth. To force
smoothness over the entire fitted curve we can restrict the the model above to
only include the cubic components:</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x +  \beta_2 x^2 + \beta_3 x^3 + \beta_4 (x-k_1)^3_{+} + \beta_5 (x-k_2)^3_{+} + \beta_6 (x-k_3)^3_{+}   + ... +  \varepsilon
\]</span></p>
<p>This will guarantee that the fitted curve is differentiable, with no sharp
changes in the direction. This is called a cubic spline.</p>
<p>An improvement of the fitting of splines in the boundary of the data is
achieved by using linear fitting before the first knot and after the last one.</p>
<iframe width="784" height="441" src="https://www.youtube.com/embed/EHfJHZhM4Aw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
</iframe>
</div>
<div id="readings" class="section level2">
<h2><span class="header-section-number">2.2</span> Readings</h2>
<p>Read the following chapters of <em>An introduction to statistical learning</em>:</p>
<ul>
<li><a href="http://faculty.marshall.usc.edu/gareth-james/ISL/ISLR%20Seventh%20Printing.pdf#page=278">7.2 Step Functions</a></li>
<li><a href="http://faculty.marshall.usc.edu/gareth-james/ISL/ISLR%20Seventh%20Printing.pdf#page=280">7.3 Basis Functions</a></li>
<li><a href="http://faculty.marshall.usc.edu/gareth-james/ISL/ISLR%20Seventh%20Printing.pdf#page=281">7.4 Regression Splines</a></li>
</ul>
</div>
<div id="practice-session" class="section level2">
<h2><span class="header-section-number">2.3</span> Practice session</h2>
<div id="task-1---fit-a-piecewise-linear-regression" class="section level3 unnumbered">
<h3>Task 1 - Fit a piecewise linear regression</h3>
<p>We will continue the example using the dataset <strong>triceps</strong> is available in the <code>MultiKink</code> package. The data contains the measurement of the triceps skin fold of 892 females (variable <em>triceps</em>) and we want to model its association with <strong>age</strong>, using piecewise linear regression with knots at 5,10,20,30 and 40.</p>
<p>First, we will load the data</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="piecewise-regression.html#cb1-1"></a><span class="co">#libraries that we will need</span></span>
<span id="cb1-2"><a href="piecewise-regression.html#cb1-2"></a><span class="co">#install.packages(&quot;MultiKink&quot;)  </span></span>
<span id="cb1-3"><a href="piecewise-regression.html#cb1-3"></a><span class="kw">library</span>(MultiKink) <span class="co">#for the data</span></span></code></pre></div>
<pre><code>## Warning: package &#39;MultiKink&#39; was built under R version 4.0.1</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="piecewise-regression.html#cb3-1"></a><span class="kw">library</span>(ggplot2)   <span class="co">#for the plots</span></span></code></pre></div>
<pre><code>## Warning: package &#39;ggplot2&#39; was built under R version 4.0.2</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="piecewise-regression.html#cb5-1"></a><span class="kw">set.seed</span>(<span class="dv">1974</span>)     <span class="co">#fix the random generator seed </span></span>
<span id="cb5-2"><a href="piecewise-regression.html#cb5-2"></a></span>
<span id="cb5-3"><a href="piecewise-regression.html#cb5-3"></a><span class="kw">data</span>(<span class="st">&quot;triceps&quot;</span>)   <span class="co">#load the dataset triceps</span></span>
<span id="cb5-4"><a href="piecewise-regression.html#cb5-4"></a>                  <span class="co">#notice that the variable of interest</span></span>
<span id="cb5-5"><a href="piecewise-regression.html#cb5-5"></a>                  <span class="co">#it is also called tricets. Don&#39;t get </span></span>
<span id="cb5-6"><a href="piecewise-regression.html#cb5-6"></a>                  <span class="co">#confused!</span></span></code></pre></div>
<p>And plot the scatter for <strong>triceps</strong> and <strong>age</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="piecewise-regression.html#cb6-1"></a> <span class="co">#simple scatter</span></span>
<span id="cb6-2"><a href="piecewise-regression.html#cb6-2"></a>  <span class="co">#we can store the scatter in an object </span></span>
<span id="cb6-3"><a href="piecewise-regression.html#cb6-3"></a>  <span class="co">#to use it later</span></span>
<span id="cb6-4"><a href="piecewise-regression.html#cb6-4"></a> tri.age.plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(triceps, <span class="kw">aes</span>(<span class="dt">x=</span>age, <span class="dt">y=</span>triceps)) <span class="op">+</span></span>
<span id="cb6-5"><a href="piecewise-regression.html#cb6-5"></a><span class="st">                 </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.55</span>, <span class="dt">color=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb6-6"><a href="piecewise-regression.html#cb6-6"></a><span class="st">                 </span><span class="kw">theme_minimal</span>() </span>
<span id="cb6-7"><a href="piecewise-regression.html#cb6-7"></a> tri.age.plot</span></code></pre></div>
<p><img src="_main_files/figure-html/plotagetric-1.png" width="672" /></p>
<p>We will fit linear models within the intervals defined by the knots. The <code>predict()</code> will give us the fitted lines.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="piecewise-regression.html#cb7-1"></a><span class="co">###Piecewise regression</span></span>
<span id="cb7-2"><a href="piecewise-regression.html#cb7-2"></a></span>
<span id="cb7-3"><a href="piecewise-regression.html#cb7-3"></a>pred1 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-4"><a href="piecewise-regression.html#cb7-4"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">5</span>,]))</span>
<span id="cb7-5"><a href="piecewise-regression.html#cb7-5"></a>pred2 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-6"><a href="piecewise-regression.html#cb7-6"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age <span class="op">&gt;=</span><span class="dv">5</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">10</span>,]))</span>
<span id="cb7-7"><a href="piecewise-regression.html#cb7-7"></a>pred3 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-8"><a href="piecewise-regression.html#cb7-8"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">10</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">20</span>,]))</span>
<span id="cb7-9"><a href="piecewise-regression.html#cb7-9"></a>pred4 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-10"><a href="piecewise-regression.html#cb7-10"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">20</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">30</span>,]))</span>
<span id="cb7-11"><a href="piecewise-regression.html#cb7-11"></a>pred5 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-12"><a href="piecewise-regression.html#cb7-12"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">30</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">40</span>,]))</span>
<span id="cb7-13"><a href="piecewise-regression.html#cb7-13"></a>pred6 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span>age, </span>
<span id="cb7-14"><a href="piecewise-regression.html#cb7-14"></a>                    <span class="dt">data =</span> triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">40</span>,]))</span></code></pre></div>
<p>And we can now add the segments to the scatter plot</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="piecewise-regression.html#cb8-1"></a>tri.age.plot <span class="op">+</span><span class="st"> </span></span>
<span id="cb8-2"><a href="piecewise-regression.html#cb8-2"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">5</span>,], </span>
<span id="cb8-3"><a href="piecewise-regression.html#cb8-3"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred1, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb8-4"><a href="piecewise-regression.html#cb8-4"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age <span class="op">&gt;=</span><span class="dv">5</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">10</span>,], </span>
<span id="cb8-5"><a href="piecewise-regression.html#cb8-5"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred2, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb8-6"><a href="piecewise-regression.html#cb8-6"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">10</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">20</span>,], </span>
<span id="cb8-7"><a href="piecewise-regression.html#cb8-7"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred3, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb8-8"><a href="piecewise-regression.html#cb8-8"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">20</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">30</span>,], </span>
<span id="cb8-9"><a href="piecewise-regression.html#cb8-9"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred4, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb8-10"><a href="piecewise-regression.html#cb8-10"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">30</span> <span class="op">&amp;</span><span class="st"> </span>triceps<span class="op">$</span>age<span class="op">&lt;</span><span class="dv">40</span>,], </span>
<span id="cb8-11"><a href="piecewise-regression.html#cb8-11"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred5, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) <span class="op">+</span></span>
<span id="cb8-12"><a href="piecewise-regression.html#cb8-12"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps[triceps<span class="op">$</span>age<span class="op">&gt;=</span><span class="dv">40</span>,], </span>
<span id="cb8-13"><a href="piecewise-regression.html#cb8-13"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred6, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>We can restrict the segments to be connected, i.e., to fit a continuous line. The model is</p>
<p><span class="math display">\[
y = \beta_0 + \beta_1 x +  \beta_2 (x-k_1)_{+}  + \beta_3 (x-k_2)_{+} + ... + \beta_6 (x-k_p)_{+} + \varepsilon\\
\]</span></p>
<p>where
<span class="math display">\[(x-k)_{+} =  \begin{cases}
                  0, &amp; \text{ if  } x &lt; k \\
                  x-k, &amp; \text{ if  } x \geq k\\
                 \end{cases} 
\]</span></p>
<p>So, we need to add the terms <span class="math inline">\((x-k)\)</span> when <span class="math inline">\(x \geq k\)</span>. We will do this by adding <span class="math inline">\(I((age-k)*(age &gt;= k))\)</span> terms to the linear model. Note that <span class="math inline">\((age &gt;= k)\)</span> is a logical statement that will be 0 (<span class="math inline">\(FALSE\)</span>) of 1 (<span class="math inline">\(TRUE\)</span>) and I() evaluates that all expression.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="piecewise-regression.html#cb9-1"></a>pred7 &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb9-2"><a href="piecewise-regression.html#cb9-2"></a><span class="st">                                   </span><span class="kw">I</span>((age<span class="dv">-10</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>)) <span class="op">+</span></span>
<span id="cb9-3"><a href="piecewise-regression.html#cb9-3"></a><span class="st">                                   </span><span class="kw">I</span>((age<span class="dv">-20</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">20</span>)) <span class="op">+</span></span>
<span id="cb9-4"><a href="piecewise-regression.html#cb9-4"></a><span class="st">                                   </span><span class="kw">I</span>((age<span class="dv">-30</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">30</span>)) <span class="op">+</span></span>
<span id="cb9-5"><a href="piecewise-regression.html#cb9-5"></a><span class="st">                                  </span><span class="kw">I</span>((age<span class="dv">-40</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">40</span>)),</span>
<span id="cb9-6"><a href="piecewise-regression.html#cb9-6"></a>                    <span class="dt">data =</span> triceps))</span>
<span id="cb9-7"><a href="piecewise-regression.html#cb9-7"></a></span>
<span id="cb9-8"><a href="piecewise-regression.html#cb9-8"></a>tri.age.plot <span class="op">+</span></span>
<span id="cb9-9"><a href="piecewise-regression.html#cb9-9"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps, </span>
<span id="cb9-10"><a href="piecewise-regression.html#cb9-10"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred7, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/jointpiece-1.png" width="672" /></p>
<p><strong>TRY IT YOURSELF:</strong></p>
<ol style="list-style-type: decimal">
<li>Using the same knots as above, fit a quadratic piecewise regression</li>
</ol>
<details>
<p><summary>See the solution code</summary></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="piecewise-regression.html#cb10-1"></a> pred.quad &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="kw">lm</span>(triceps<span class="op">~</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(age<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb10-2"><a href="piecewise-regression.html#cb10-2"></a><span class="st">                    </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">^</span><span class="dv">2</span><span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb10-3"><a href="piecewise-regression.html#cb10-3"></a><span class="st">                    </span><span class="kw">I</span>((age<span class="dv">-10</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">^</span><span class="dv">2</span><span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb10-4"><a href="piecewise-regression.html#cb10-4"></a><span class="st">                    </span><span class="kw">I</span>((age<span class="dv">-20</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">20</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">^</span><span class="dv">2</span><span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb10-5"><a href="piecewise-regression.html#cb10-5"></a><span class="st">                    </span><span class="kw">I</span>((age<span class="dv">-30</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">30</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">^</span><span class="dv">2</span><span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb10-6"><a href="piecewise-regression.html#cb10-6"></a><span class="st">                    </span><span class="kw">I</span>((age<span class="dv">-40</span>)<span class="op">*</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">40</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((age<span class="dv">-5</span>)<span class="op">^</span><span class="dv">2</span><span class="op">*</span>(age<span class="op">&gt;=</span><span class="dv">5</span>)),</span>
<span id="cb10-7"><a href="piecewise-regression.html#cb10-7"></a>                    <span class="dt">data =</span> triceps))</span>
<span id="cb10-8"><a href="piecewise-regression.html#cb10-8"></a></span>
<span id="cb10-9"><a href="piecewise-regression.html#cb10-9"></a>tri.age.plot <span class="op">+</span></span>
<span id="cb10-10"><a href="piecewise-regression.html#cb10-10"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span>triceps, </span>
<span id="cb10-11"><a href="piecewise-regression.html#cb10-11"></a>            <span class="kw">aes</span>(<span class="dt">y =</span> pred.quad, <span class="dt">x=</span>age), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col=</span><span class="st">&quot;blue&quot;</span>) </span></code></pre></div>
<img src="_main_files/figure-html/quadpiece-1.png" width="672" />
</details>
<p>
<p>
</div>
<div id="task-2---fit-a-natural-cubic-spline" class="section level3 unnumbered">
<h3>Task 2 - Fit a natural cubic spline</h3>
<p>We will the same dataset <strong>triceps</strong> as in TASK 1 to fit a natural cubic spline
for the association of <strong>age</strong> and <strong>triceps</strong>.</p>
<p>The function <code>bs()</code> in the <code>splines</code> package generates the B-spline basis matrix
for a polynomial spline, and the function <code>ns()</code> in the same library generates
the B-spline basis matrix matrix for a natural cubic spline (restriction that
the fitted curve linear at the extremes). We will compare both.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="piecewise-regression.html#cb11-1"></a><span class="kw">library</span>(splines)</span>
<span id="cb11-2"><a href="piecewise-regression.html#cb11-2"></a><span class="kw">library</span>(MultiKink) <span class="co">#for the data</span></span>
<span id="cb11-3"><a href="piecewise-regression.html#cb11-3"></a><span class="kw">library</span>(ggplot2)   <span class="co">#for the plots</span></span>
<span id="cb11-4"><a href="piecewise-regression.html#cb11-4"></a><span class="kw">set.seed</span>(<span class="dv">1974</span>)     <span class="co">#fix the random generator seed </span></span>
<span id="cb11-5"><a href="piecewise-regression.html#cb11-5"></a></span>
<span id="cb11-6"><a href="piecewise-regression.html#cb11-6"></a><span class="kw">data</span>(<span class="st">&quot;triceps&quot;</span>)   <span class="co">#load the dataset triceps</span></span>
<span id="cb11-7"><a href="piecewise-regression.html#cb11-7"></a>                  <span class="co">#notice that the variable of interest</span></span>
<span id="cb11-8"><a href="piecewise-regression.html#cb11-8"></a>                  <span class="co">#it is also called triceps. Don&#39;t get </span></span>
<span id="cb11-9"><a href="piecewise-regression.html#cb11-9"></a>                  <span class="co">#confused!</span></span>
<span id="cb11-10"><a href="piecewise-regression.html#cb11-10"></a></span>
<span id="cb11-11"><a href="piecewise-regression.html#cb11-11"></a><span class="co">#linear model with the natural cubic splines function </span></span>
<span id="cb11-12"><a href="piecewise-regression.html#cb11-12"></a>cub.splines.bs &lt;-<span class="st"> </span><span class="kw">lm</span>(triceps <span class="op">~</span><span class="st"> </span><span class="kw">bs</span>(age, <span class="dt">knots =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>)), </span>
<span id="cb11-13"><a href="piecewise-regression.html#cb11-13"></a>                   <span class="dt">data=</span>triceps)</span>
<span id="cb11-14"><a href="piecewise-regression.html#cb11-14"></a><span class="kw">summary</span>(cub.splines.bs)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = triceps ~ bs(age, knots = c(5, 10, 20, 30, 40)), 
##     data = triceps)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -11.5234  -1.6912  -0.2917   1.1356  23.0922 
## 
## Coefficients:
##                                        Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                              6.9598     0.9729   7.154 1.77e-12 ***
## bs(age, knots = c(5, 10, 20, 30, 40))1   2.5367     1.7154   1.479   0.1396    
## bs(age, knots = c(5, 10, 20, 30, 40))2  -0.3032     0.9629  -0.315   0.7529    
## bs(age, knots = c(5, 10, 20, 30, 40))3  -1.9092     1.2993  -1.469   0.1421    
## bs(age, knots = c(5, 10, 20, 30, 40))4   7.4056     1.2179   6.081 1.78e-09 ***
## bs(age, knots = c(5, 10, 20, 30, 40))5   6.1050     1.4043   4.347 1.54e-05 ***
## bs(age, knots = c(5, 10, 20, 30, 40))6  10.1770     1.5427   6.597 7.23e-11 ***
## bs(age, knots = c(5, 10, 20, 30, 40))7   3.9428     1.9082   2.066   0.0391 *  
## bs(age, knots = c(5, 10, 20, 30, 40))8  10.1473     1.7545   5.784 1.01e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.743 on 883 degrees of freedom
## Multiple R-squared:  0.4261,	Adjusted R-squared:  0.4209 
## F-statistic: 81.94 on 8 and 883 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="piecewise-regression.html#cb13-1"></a>cub.splines.ns &lt;-<span class="st"> </span><span class="kw">lm</span>(triceps <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(age, <span class="dt">knots =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>)), </span>
<span id="cb13-2"><a href="piecewise-regression.html#cb13-2"></a>                   <span class="dt">data=</span>triceps)</span>
<span id="cb13-3"><a href="piecewise-regression.html#cb13-3"></a></span>
<span id="cb13-4"><a href="piecewise-regression.html#cb13-4"></a><span class="kw">summary</span>(cub.splines.ns)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = triceps ~ ns(age, knots = c(5, 10, 20, 30, 40)), 
##     data = triceps)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -10.4875  -1.6873  -0.3665   1.1146  22.8643 
## 
## Coefficients:
##                                        Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                              8.3811     0.5219  16.059  &lt; 2e-16 ***
## ns(age, knots = c(5, 10, 20, 30, 40))1  -3.5592     0.6712  -5.303 1.44e-07 ***
## ns(age, knots = c(5, 10, 20, 30, 40))2   5.7803     1.0379   5.569 3.39e-08 ***
## ns(age, knots = c(5, 10, 20, 30, 40))3   5.5118     0.9416   5.853 6.78e-09 ***
## ns(age, knots = c(5, 10, 20, 30, 40))4   6.9070     0.9050   7.632 5.99e-14 ***
## ns(age, knots = c(5, 10, 20, 30, 40))5   5.4136     1.3783   3.928 9.24e-05 ***
## ns(age, knots = c(5, 10, 20, 30, 40))6   6.6460     1.0829   6.137 1.27e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.759 on 885 degrees of freedom
## Multiple R-squared:  0.4199,	Adjusted R-squared:  0.416 
## F-statistic: 106.8 on 6 and 885 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Notice that are less regression parameters for the natural spline due to the
linearity restriction. We can see this in the plot. To plot we could either
get predictions from the fitted models or fit the models in the <code>ggplot</code>
function directly:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="piecewise-regression.html#cb15-1"></a> <span class="co">#simple scatter</span></span>
<span id="cb15-2"><a href="piecewise-regression.html#cb15-2"></a> tri.age.plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>(triceps, <span class="kw">aes</span>(<span class="dt">x=</span>age, <span class="dt">y=</span>triceps)) <span class="op">+</span></span>
<span id="cb15-3"><a href="piecewise-regression.html#cb15-3"></a><span class="st">                 </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.55</span>, <span class="dt">color=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-4"><a href="piecewise-regression.html#cb15-4"></a><span class="st">                 </span><span class="kw">theme_minimal</span>() </span>
<span id="cb15-5"><a href="piecewise-regression.html#cb15-5"></a> </span>
<span id="cb15-6"><a href="piecewise-regression.html#cb15-6"></a>  tri.age.plot <span class="op">+</span></span>
<span id="cb15-7"><a href="piecewise-regression.html#cb15-7"></a><span class="st">    </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, </span>
<span id="cb15-8"><a href="piecewise-regression.html#cb15-8"></a>               <span class="dt">formula =</span> y<span class="op">~</span><span class="kw">bs</span>(x,<span class="dt">knots =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>)), </span>
<span id="cb15-9"><a href="piecewise-regression.html#cb15-9"></a>               <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-10"><a href="piecewise-regression.html#cb15-10"></a><span class="st">    </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, </span>
<span id="cb15-11"><a href="piecewise-regression.html#cb15-11"></a>               <span class="dt">formula =</span> y<span class="op">~</span><span class="kw">ns</span>(x,<span class="dt">knots =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>)), </span>
<span id="cb15-12"><a href="piecewise-regression.html#cb15-12"></a>               <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)  </span></code></pre></div>
<p><img src="_main_files/figure-html/addcubi-1.png" width="672" /></p>
<p><strong>TRY IT YOURSELF:</strong></p>
<ol style="list-style-type: decimal">
<li>Fit a natural spline with 6 degrees of freedom and compare it with the
natural spline using <code>knots = c(5,10,20,30,40)</code>. What is the difference?</li>
</ol>
<details>
<p><summary>See the solution code</summary></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="piecewise-regression.html#cb16-1"></a> tri.age.plot <span class="op">+</span></span>
<span id="cb16-2"><a href="piecewise-regression.html#cb16-2"></a><span class="st">    </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, </span>
<span id="cb16-3"><a href="piecewise-regression.html#cb16-3"></a>               <span class="dt">formula =</span> y<span class="op">~</span><span class="kw">ns</span>(x,<span class="dt">knots =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>)), </span>
<span id="cb16-4"><a href="piecewise-regression.html#cb16-4"></a>               <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-5"><a href="piecewise-regression.html#cb16-5"></a><span class="st">    </span><span class="kw">stat_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, </span>
<span id="cb16-6"><a href="piecewise-regression.html#cb16-6"></a>               <span class="dt">formula =</span> y<span class="op">~</span><span class="kw">ns</span>(x,<span class="dt">df=</span><span class="dv">6</span>), </span>
<span id="cb16-7"><a href="piecewise-regression.html#cb16-7"></a>               <span class="dt">lty =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="st">&quot;yellow&quot;</span>)      </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="piecewise-regression.html#cb17-1"></a><span class="co">#df=6 also chooses 5 knots but the knots</span></span>
<span id="cb17-2"><a href="piecewise-regression.html#cb17-2"></a><span class="co">#are based on the quantiles of the data</span></span>
<span id="cb17-3"><a href="piecewise-regression.html#cb17-3"></a><span class="co">#in this case the knots are at values:</span></span>
<span id="cb17-4"><a href="piecewise-regression.html#cb17-4"></a><span class="kw">attr</span>(<span class="kw">ns</span>(triceps<span class="op">$</span>age, <span class="dt">df=</span><span class="dv">6</span>), <span class="st">&quot;knots&quot;</span>) </span></code></pre></div>
<pre><code>## 16.66667% 33.33333%       50% 66.66667% 83.33333% 
##      3.76      7.67     12.21     18.12     32.55</code></pre>
</details>
<p>
<p>
<ol start="2" style="list-style-type: decimal">
<li>Calculate the MSE (or the root mean squared error) for the models using
natural cubic splines with <span class="math inline">\(df\)</span> from 2 (linear model) up to 20. You can use the library <code>caret</code>.</li>
</ol>
<details>
<p><summary>See the solution code</summary></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="piecewise-regression.html#cb19-1"></a><span class="kw">library</span>(caret)</span></code></pre></div>
<pre><code>## Loading required package: lattice</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="piecewise-regression.html#cb21-1"></a><span class="kw">set.seed</span>(<span class="dv">1001</span>)</span>
<span id="cb21-2"><a href="piecewise-regression.html#cb21-2"></a></span>
<span id="cb21-3"><a href="piecewise-regression.html#cb21-3"></a><span class="co">#repeated CV for the MSE</span></span>
<span id="cb21-4"><a href="piecewise-regression.html#cb21-4"></a>trC.lm &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;repeatedcv&quot;</span>, </span>
<span id="cb21-5"><a href="piecewise-regression.html#cb21-5"></a>                         <span class="dt">number =</span> <span class="dv">10</span>, </span>
<span id="cb21-6"><a href="piecewise-regression.html#cb21-6"></a>                         <span class="dt">repeats =</span> <span class="dv">10</span>)</span>
<span id="cb21-7"><a href="piecewise-regression.html#cb21-7"></a></span>
<span id="cb21-8"><a href="piecewise-regression.html#cb21-8"></a><span class="co">#function to fit a spline with x degrees of freedom</span></span>
<span id="cb21-9"><a href="piecewise-regression.html#cb21-9"></a>  my.spline.f &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb21-10"><a href="piecewise-regression.html#cb21-10"></a>    <span class="co">#need to construct the model formula</span></span>
<span id="cb21-11"><a href="piecewise-regression.html#cb21-11"></a>    spline.formula &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;triceps ~ ns(age, df=&quot;</span>,x, <span class="st">&quot;)&quot;</span> ))                                          </span>
<span id="cb21-12"><a href="piecewise-regression.html#cb21-12"></a>    pol.model &lt;-<span class="st"> </span><span class="kw">train</span>(spline.formula,                   </span>
<span id="cb21-13"><a href="piecewise-regression.html#cb21-13"></a>                        <span class="dt">data =</span> triceps,            </span>
<span id="cb21-14"><a href="piecewise-regression.html#cb21-14"></a>                        <span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>,</span>
<span id="cb21-15"><a href="piecewise-regression.html#cb21-15"></a>                        <span class="dt">trControl =</span> trC.lm)</span>
<span id="cb21-16"><a href="piecewise-regression.html#cb21-16"></a>    </span>
<span id="cb21-17"><a href="piecewise-regression.html#cb21-17"></a>    RMSE.cv =<span class="st"> </span>pol.model<span class="op">$</span>results[<span class="dv">2</span>]                <span class="co">#extracts the RMSE</span></span>
<span id="cb21-18"><a href="piecewise-regression.html#cb21-18"></a>  }</span>
<span id="cb21-19"><a href="piecewise-regression.html#cb21-19"></a>  </span>
<span id="cb21-20"><a href="piecewise-regression.html#cb21-20"></a>  <span class="co">#RMSE</span></span>
<span id="cb21-21"><a href="piecewise-regression.html#cb21-21"></a>  <span class="kw">t</span>(<span class="kw">sapply</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">20</span>, my.spline.f))                    <span class="co">#Computes the RMSE for splines</span></span>
<span id="cb21-22"><a href="piecewise-regression.html#cb21-22"></a>                                                  <span class="co">#with df degrees 2 to 20</span></span>
<span id="cb21-23"><a href="piecewise-regression.html#cb21-23"></a>  <span class="co">###########################################################################</span></span>
<span id="cb21-24"><a href="piecewise-regression.html#cb21-24"></a>  <span class="co">#if you want to plot the curves,</span></span>
<span id="cb21-25"><a href="piecewise-regression.html#cb21-25"></a>  <span class="co">#it is tricky to get ggplot to work </span></span>
<span id="cb21-26"><a href="piecewise-regression.html#cb21-26"></a>  <span class="co">#within a loop. This is a solutions:</span></span>
<span id="cb21-27"><a href="piecewise-regression.html#cb21-27"></a>  col.ran &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">colours</span>(), <span class="dv">20</span>)                  <span class="co">#colours for the lines</span></span>
<span id="cb21-28"><a href="piecewise-regression.html#cb21-28"></a>  my.plot&lt;-<span class="st"> </span>tri.age.plot                            <span class="co">#scatterplot</span></span>
<span id="cb21-29"><a href="piecewise-regression.html#cb21-29"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="dv">20</span>){</span>
<span id="cb21-30"><a href="piecewise-regression.html#cb21-30"></a>      <span class="co">#builds the stat_smooth with df=i</span></span>
<span id="cb21-31"><a href="piecewise-regression.html#cb21-31"></a>      loop_input &lt;-<span class="st">  </span><span class="kw">paste</span>(<span class="st">&quot;stat_smooth(method = </span><span class="ch">\&quot;</span><span class="st">lm</span><span class="ch">\&quot;</span><span class="st">, </span></span>
<span id="cb21-32"><a href="piecewise-regression.html#cb21-32"></a><span class="st">                          formula = y~ns(x,df=&quot;</span>,i,<span class="st">&quot;), </span></span>
<span id="cb21-33"><a href="piecewise-regression.html#cb21-33"></a><span class="st">                          lty = 1, col =</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,col.ran[i],<span class="st">&quot;</span><span class="ch">\&quot;</span><span class="st">, </span></span>
<span id="cb21-34"><a href="piecewise-regression.html#cb21-34"></a><span class="st">                          se = FALSE)&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb21-35"><a href="piecewise-regression.html#cb21-35"></a>      </span>
<span id="cb21-36"><a href="piecewise-regression.html#cb21-36"></a>      <span class="co">#updates the scatter plot with </span></span>
<span id="cb21-37"><a href="piecewise-regression.html#cb21-37"></a>      <span class="co">#the new spline</span></span>
<span id="cb21-38"><a href="piecewise-regression.html#cb21-38"></a>      my.plot &lt;-<span class="st"> </span>my.plot <span class="op">+</span><span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span>loop_input))    </span>
<span id="cb21-39"><a href="piecewise-regression.html#cb21-39"></a>  }</span>
<span id="cb21-40"><a href="piecewise-regression.html#cb21-40"></a>  </span>
<span id="cb21-41"><a href="piecewise-regression.html#cb21-41"></a> my.plot</span></code></pre></div>
<img src="_main_files/figure-html/allxplot-1.png" width="672" />
</details>
<p>
<p>
</div>
</div>
<div id="exercises" class="section level2">
<h2><span class="header-section-number">2.4</span> Exercises</h2>
<p>Solve the following exercise:</p>
<ol style="list-style-type: decimal">
<li>The dataset <a href="https://www.dropbox.com/s/cwkw3p91zyizcqz/SA_heart.csv?dl=1">SA_heart.csv</a>
contains on coronary heart disease status (variable <em>chd</em>) and several risk
factors including the cumulative tobacco comsumption <em>tobacco</em>.</li>
</ol>
<ol style="list-style-type: lower-alpha">
<li><p>Fit a logistic model for <em>chd</em> using the predictor <em>tobacco</em>
(as a linear effect) and compute its AIC</p></li>
<li><p>Plot the fitted curve in a)</p></li>
<li><p>Fit a logistic model for <em>chd</em> with a natural cubic spline for the predictor <em>tobacco</em>, with <span class="math inline">\(df\)</span> 5 and 10. Compute the AIC of the two models.</p></li>
<li><p>Plot the fitted curves in c)</p></li>
<li><p>Compute the cross-validated ROC of the models a) and c) (use the <code>caret</code> package)</p></li>
</ol>
<details>
<p><summary>See the solution code for e)</summary></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="piecewise-regression.html#cb22-1"></a>    <span class="kw">library</span>(caret)</span>
<span id="cb22-2"><a href="piecewise-regression.html#cb22-2"></a>    <span class="kw">library</span>(splines)</span>
<span id="cb22-3"><a href="piecewise-regression.html#cb22-3"></a>    <span class="kw">set.seed</span>(<span class="dv">2001</span>)</span>
<span id="cb22-4"><a href="piecewise-regression.html#cb22-4"></a>    SA_heart &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;https://www.dropbox.com/s/cwkw3p91zyizcqz/SA_heart.csv?dl=1&quot;</span>)</span>
<span id="cb22-5"><a href="piecewise-regression.html#cb22-5"></a>    </span>
<span id="cb22-6"><a href="piecewise-regression.html#cb22-6"></a>    <span class="co"># caret will give an error for factors coded as 0 and 1</span></span>
<span id="cb22-7"><a href="piecewise-regression.html#cb22-7"></a>    <span class="co"># because it uses the factors names to create</span></span>
<span id="cb22-8"><a href="piecewise-regression.html#cb22-8"></a>    <span class="co"># names of internal variables. This way it is better</span></span>
<span id="cb22-9"><a href="piecewise-regression.html#cb22-9"></a>    <span class="co">#to use an outcome variable with strings as the factor names</span></span>
<span id="cb22-10"><a href="piecewise-regression.html#cb22-10"></a>    SA_heart<span class="op">$</span>chd.f &lt;-<span class="st"> </span><span class="kw">ifelse</span>(SA_heart<span class="op">$</span>chd <span class="op">==</span><span class="dv">1</span>, </span>
<span id="cb22-11"><a href="piecewise-regression.html#cb22-11"></a>                             <span class="st">&quot;chd&quot;</span>, </span>
<span id="cb22-12"><a href="piecewise-regression.html#cb22-12"></a>                             <span class="st">&quot;nochd&quot;</span>)     </span>
<span id="cb22-13"><a href="piecewise-regression.html#cb22-13"></a>    </span>
<span id="cb22-14"><a href="piecewise-regression.html#cb22-14"></a>    <span class="co">#sets the control for 10-fold cross-validation, 10 times</span></span>
<span id="cb22-15"><a href="piecewise-regression.html#cb22-15"></a>    <span class="co"># the classProbs = TRUE and summaryFunction = twoClassSummary</span></span>
<span id="cb22-16"><a href="piecewise-regression.html#cb22-16"></a>    <span class="co"># store the information to compute the area under the ROC</span></span>
<span id="cb22-17"><a href="piecewise-regression.html#cb22-17"></a>    trC.lm &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;repeatedcv&quot;</span>, </span>
<span id="cb22-18"><a href="piecewise-regression.html#cb22-18"></a>                           <span class="dt">number =</span> <span class="dv">10</span>, </span>
<span id="cb22-19"><a href="piecewise-regression.html#cb22-19"></a>                           <span class="dt">repeats =</span> <span class="dv">10</span>,</span>
<span id="cb22-20"><a href="piecewise-regression.html#cb22-20"></a>                           <span class="dt">classProbs =</span> <span class="ot">TRUE</span>,                 <span class="co">#necessary for </span></span>
<span id="cb22-21"><a href="piecewise-regression.html#cb22-21"></a>                           <span class="dt">summaryFunction =</span> twoClassSummary) <span class="co">#the AUC ROC</span></span>
<span id="cb22-22"><a href="piecewise-regression.html#cb22-22"></a></span>
<span id="cb22-23"><a href="piecewise-regression.html#cb22-23"></a>     <span class="co">#linear effect</span></span>
<span id="cb22-24"><a href="piecewise-regression.html#cb22-24"></a>     roc.l &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="dt">form =</span> chd.f  <span class="op">~</span><span class="st"> </span>tobacco,</span>
<span id="cb22-25"><a href="piecewise-regression.html#cb22-25"></a>                    <span class="dt">data =</span> SA_heart,</span>
<span id="cb22-26"><a href="piecewise-regression.html#cb22-26"></a>                    <span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb22-27"><a href="piecewise-regression.html#cb22-27"></a>                    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb22-28"><a href="piecewise-regression.html#cb22-28"></a>                    <span class="dt">trControl =</span> trC.lm,</span>
<span id="cb22-29"><a href="piecewise-regression.html#cb22-29"></a>                    <span class="dt">metric =</span> <span class="st">&quot;ROC&quot;</span>) </span>
<span id="cb22-30"><a href="piecewise-regression.html#cb22-30"></a>     </span>
<span id="cb22-31"><a href="piecewise-regression.html#cb22-31"></a>     roc<span class="fl">.5</span> &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="dt">form =</span> chd.f  <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(tobacco,<span class="dt">df=</span><span class="dv">5</span>),</span>
<span id="cb22-32"><a href="piecewise-regression.html#cb22-32"></a>                    <span class="dt">data =</span> SA_heart,</span>
<span id="cb22-33"><a href="piecewise-regression.html#cb22-33"></a>                    <span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb22-34"><a href="piecewise-regression.html#cb22-34"></a>                    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb22-35"><a href="piecewise-regression.html#cb22-35"></a>                    <span class="dt">trControl =</span> trC.lm,</span>
<span id="cb22-36"><a href="piecewise-regression.html#cb22-36"></a>                    <span class="dt">metric =</span> <span class="st">&quot;ROC&quot;</span>) </span>
<span id="cb22-37"><a href="piecewise-regression.html#cb22-37"></a>     <span class="co">#cubic effect</span></span>
<span id="cb22-38"><a href="piecewise-regression.html#cb22-38"></a>     roc<span class="fl">.10</span> &lt;-<span class="st"> </span><span class="kw">train</span>(<span class="dt">form =</span> chd.f  <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(tobacco,<span class="dt">df=</span><span class="dv">10</span>),</span>
<span id="cb22-39"><a href="piecewise-regression.html#cb22-39"></a>                    <span class="dt">data =</span> SA_heart,</span>
<span id="cb22-40"><a href="piecewise-regression.html#cb22-40"></a>                    <span class="dt">method =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb22-41"><a href="piecewise-regression.html#cb22-41"></a>                    <span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>,</span>
<span id="cb22-42"><a href="piecewise-regression.html#cb22-42"></a>                    <span class="dt">trControl =</span> trC.lm,</span>
<span id="cb22-43"><a href="piecewise-regression.html#cb22-43"></a>                    <span class="dt">metric =</span> <span class="st">&quot;ROC&quot;</span>) </span>
<span id="cb22-44"><a href="piecewise-regression.html#cb22-44"></a>  </span>
<span id="cb22-45"><a href="piecewise-regression.html#cb22-45"></a>     roc.l</span>
<span id="cb22-46"><a href="piecewise-regression.html#cb22-46"></a>     roc<span class="fl">.5</span></span>
<span id="cb22-47"><a href="piecewise-regression.html#cb22-47"></a>     roc<span class="fl">.10</span></span></code></pre></div>
</details>
<p>
<p>
<ol start="6" style="list-style-type: lower-alpha">
<li>Which model would you prefer?</li>
</ol>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="polynomial-regression.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="piecewise-regression.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "subsection"
},
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
